# telegram-web-scraper
UserScript для сбора сообщений из каналов Telegram и отправки в n8n или другую систему.
# Пользовательский скрипт для сбора данных из Telegram Web

Пользовательский скрипт (UserScript) для сбора сообщений из указанных Telegram-каналов (при просмотре через web.telegram.org) и их отправки на настроенный веб-хук n8n.

## Возможности

*   Сбор сообщений с текущего активного канала или из предопределенного списка каналов.
*   Графический пользовательский интерфейс (GUI) для легкой настройки параметров, реализованный с помощью GM_config.
*   Фильтрация сообщений по максимальному возрасту для предотвращения обработки очень старых данных.
*   Автоматическая навигация между каналами в режиме многоканального сбора.
*   Использование рандомизированных задержек для лучшей имитации действий человека.
*   Управление через команды меню Tampermonkey/Violentmonkey.
*   Двуязычные комментарии (английский/русский) в коде скрипта.

## Установка

1.  **Установите менеджер пользовательских скриптов**:
    *   [Tampermonkey](https://www.tampermonkey.net/) (Рекомендуется для Chrome, Edge, Safari, Opera, Firefox)
    *   [Violentmonkey](https://violentmonkey.github.io/) (Рекомендуется для Firefox, Chrome, Edge, Opera)
    *   Или любой другой менеджер UserScript, поддерживающий директивы `@require` и `@grant`.

2.  **Установите скрипт**:
    *   **Нажмите здесь для установки**: [https://github.com/LebedevIV/telegram-web-scraper/raw/refs/heads/main/telegram-scraper.user.js](https://github.com/LebedevIV/telegram-web-scraper/raw/refs/heads/main/telegram-scraper.user.js)
    *   (Замените `ВАШ_НИКНЕЙМ_GITHUB` и `ИМЯ_ВАШЕГО_РЕПОЗИТОРИЯ` на ваше актуальное имя пользователя GitHub и название репозитория. Также убедитесь, что `main` — это имя вашей основной ветки; для старых репозиториев это может быть `master`.)
    *   Либо перейдите к файлу `telegram-scraper.user.js` в этом репозитории, нажмите кнопку "Raw", и ваш менеджер UserScript должен предложить вам установить его.

## Конфигурация

После установки откройте Telegram Web (например, web.telegram.org/k/). Доступ к настройкам скрипта можно получить через иконку вашего менеджера UserScript в браузере:

*   Нажмите на иконку Tampermonkey/Violentmonkey.
*   Найдите "Telegram Scraper (Menu Commands vX.X.X)" в списке активных скриптов.
*   Выберите "Настройки скрипта... / Script Settings..." из его выпадающего меню.

Ключевые настройки включают:
*   **URL веб-хука n8n (N8N Webhook URL)**: URL вашего веб-хука n8n, который будет получать собранные данные.
*   **Макс. возраст сообщений (часы) (Max message age (hours))**: Сообщения старше этого возраста будут игнорироваться.
*   Различные параметры времени и попыток для сбора данных и навигации.

Значения по умолчанию и информация о необходимости перезагрузки указаны рядом с каждой настройкой в GUI.

## Использование

Скрипт добавляет команды в меню вашего менеджера UserScript для вкладки Telegram Web:

*   **Scrape Current Channel / Собрать с текущего канала**: Начинает сбор сообщений с канала, открытого в данный момент в Telegram Web.
*   **Scrape All Listed Channels / Собрать со всех каналов**: Перебирает список `TARGET_CHANNELS_DATA`, определенный в скрипте, собирая данные с каждого из них.
*   **Stop All Scraping / Остановить всё**: Немедленно останавливает любые активные процессы сбора данных.
*   **Настройки скрипта... / Script Settings...**: Открывает графический интерфейс настроек.

Прогресс сбора данных и логи выводятся в консоль разработчика браузера (F12).

## Зависимости

*   **GM_config.js**: Эта библиотека загружается через директиву `@require` с `openuserjs.org` для предоставления графического интерфейса настроек.
*   **Веб-хук n8n (n8n Webhook)**: Вам необходим активный экземпляр n8n с рабочим процессом (workflow) веб-хука, готовым принимать JSON-данные через POST-запросы.

## Устранение неполадок

*   **Скрипт не запускается**: Убедитесь, что Tampermonkey/Violentmonkey включен и скрипт активен для `web.telegram.org`. Проверьте консоль браузера на наличие ошибок.
*   **GUI настроек не появляется**: Проверьте консоль на ошибки, связанные с `GM_config.js`. URL в `@require` может быть временно недоступен, или мог возникнуть конфликт.
*   **Данные не доходят до n8n**:
    *   Убедитесь, что "URL веб-хука n8n" в настройках скрипта указан верно и доступен из вашего браузера.
    *   Проверьте ваш рабочий процесс n8n на наличие ошибок и убедитесь, что он активен.
    *   Ищите ошибки `GM_xmlhttpRequest` в консоли браузера.

## Лицензия

Этот проект лицензирован под [лицензией MIT](LICENSE).

## Имитация человеческого поведения (Настройка скорости)

Скрипт включает различные параметры времени, которые можно настроить, чтобы сделать его работу медленнее и более похожей на действия человека. Это может быть полезно, чтобы избежать потенциальных ограничений скорости или обнаружения со стороны Telegram, хотя основной целью является сбор данных.

Вы можете настроить эти параметры через графический интерфейс скрипта ("Настройки скрипта... / Script Settings..."):

### Ключевые параметры для настройки более медленного и "человекоподобного" сбора:

1.  **Основные паузы в работе:**
    *   **`Базовый интервал скрапинга (мс)`**: (По умолч.: `30000`) Это основная пауза между обработкой "порций" сообщений при прокрутке канала вверх. Увеличение этого значения (например, до `60000` - `120000` мс) значительно замедлит переход к более старым сообщениям.
    *   **`Пауза после скролла (мс)`**: (По умолч.: `5000`) Пауза после каждого действия прокрутки (вверх или вниз). Увеличение (например, до `7000` - `15000` мс) имитирует "чтение" пользователем сообщений после прокрутки.

2.  **Паузы навигации и активации (для многоканального режима):**
    *   **`Пауза после навигации (мс)`**: (По умолч.: `2500`) Пауза после изменения URL-хэша для переключения каналов. Увеличьте до `3000` - `5000` мс, если каналы загружаются медленно.
    *   **`Пауза между попытками активации канала (мс)`**: (По умолч.: `700`) Пауза между проверками активности целевого канала. Можно немного увеличить при необходимости (например, `1000` - `1500` мс).

3.  **Паузы при прокрутке "Вниз":**
    *   **`Пауза после клика по кнопке "вниз" (мс)`**: (По умолч.: `2500`) Пауза после нажатия кнопки "вниз" (со счетчиком непрочитанных). Увеличьте до `3000` - `5000` мс.
    *   **`Пауза при программном скролле вниз (мс)`**: (По умолч.: `700`) Пауза между итерациями программной прокрутки до самого низа. Увеличьте до `1000` - `2000` мс.

4.  **Задержки действий и отправки:**
    *   **`Пауза перед/после действия скролла (мс)`**: (По умолч.: `300`) Короткая пауза перед обработкой сообщений или прокруткой вверх. Увеличьте до `500` - `1000` мс для небольшой "задумчивости".
    *   **`Задержка перед отправкой каждого сообщения в n8n (мс)`**: (По умолч.: `1000`) Пауза между отправкой отдельных сообщений на ваш веб-хук n8n. Увеличение (например, `1500` - `3000` мс) снижает частоту запросов к вашему n8n.

5.  **Коэффициенты случайности:**
    *   **`Коэф. случайности для основных пауз (0.0-1.0)`**: (По умолч.: `0.3`) Добавляет вариативности к длительным паузам. Значение `0.3` означает +/- 15% от базовой паузы. Небольшое увеличение (например, до `0.4` - `0.5`) может сделать паузы менее предсказуемыми.
    *   **`Коэф. случайности для малых пауз (0.0-1.0)`**: (По умолч.: `0.15`) Добавляет вариативности к коротким паузам. Можно немного увеличить (например, до `0.2` - `0.25`).

6.  **Случайный порядок каналов:**
    *   **`Случайный порядок каналов при мульти-сборе`**: (По умолч.: `true`) Если включено, скрипт будет перемешивать список целевых каналов перед запуском задачи "Собрать со всех каналов". Это делает паттерн сбора менее предсказуемым, если вы запускаете его часто.

**Пример "замедленной" конфигурации:**
*   `Базовый интервал скрапинга (мс)`: `90000` (1.5 минуты)
*   `Пауза после скролла (мс)`: `10000` (10 секунд)
*   `Задержка перед отправкой каждого сообщения в n8n (мс)`: `2500` (2.5 секунды)
*   `Коэф. случайности для основных пауз`: `0.4`

Экспериментируйте с этими значениями, чтобы найти баланс, который соответствует вашим потребностям и делает активность скрипта более естественной. Помните, что значительное увеличение всех пауз сделает общий процесс сбора данных намного дольше.
